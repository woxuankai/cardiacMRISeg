% !Mode:: "TeX:UTF-8"

\chapter{多图谱分割方法}

\section{常见医学图像分割方法}
\subsection{err}


\section{图像配准方法}
图像配准(image registration)是多图谱分割方法的重中之重，
图像配准的好坏对最终的分割结果有着直接的影响。

\subsection{图像配准概述}
在医学图像的采集过程中，由于成像原理（MRI, CT, PET, 超声等）、设备、参数的不同，
或者患者同一部位不同时间的形态变化，甚至不同被试者同一部位的结构差别，
会导致成像结果的差异。
而在实际中，将不同的医学图像进行观察，是比较常见的。例如：
\begin{enumerate}
  \item 在数字剪影血管造影(DSA)中，将注射造影剂之前和之后的图像进行相减。
  \item 将患者某一部位的影像和标准影像进行对比。
  \item 将功能成像（例如正电子发射成像，PET）%
    和解剖成像（例如磁共振图像，MRI）综合观察。
\end{enumerate}
如果我们想要综合不同图像进行观察，首先要做的就是将图像``对齐''
，这种所谓的对齐，便是图像配准
\footnote{这里使用了``对齐''这一说法，其实并不准确。
因为``对齐''字面上可能让人误以为只发生平移变换，
而实际上，为了使一幅图像与另一幅图像尽可能吻合，
还需要用到旋转、缩放等等变换。
在实际的配准过程中，这种对齐甚至可以包括仿射变换以及非刚性变换。}。

总的来说，配准，是一个在不同图像之间建立空间上的联系的过程\citeup{MultiAtlasSurvey}，
图\ref{RegistrationIsMapping}形象阐释了这一概念。
\pic[ht]{配准是在图像之间建立空间变换\citeup{ITKBookDevelop}}%
{width=0.6\textwidth}{RegistrationIsMapping}

考虑在两幅图像间配准的情况，
通常一幅图像被称为原图像(source image)或者固定图像(fixed image)，
另一幅图像被称为目标图像(target image)或者浮动图像(moving image)。
用$S$表示固定图像，$T$指代浮动图像，
两幅定义域为$\Omega$的图像通过变换$W$相关联。
配准的目的就是估计出一个最佳的的变换$W$来优化以下这个形式的能量函数
\citeup{DeformableRegistrationSurvey}。
\begin{equation}\label{LossFunction}
\mathcal{M}(T,S\circ W)+\mathcal{R}(W)
\end{equation}
函数由两部分组成，
第一部分刻画了T和用W变换后的S的``对齐''程度，
在这个优化问题中，
需要最大化还是最小化这个能量函数取决于$\mathcal{M}$的定义。
式子的后一项$\mathcal{R}(W)$被称为正则项(regularization)，
引入了对变换$W$的一个偏好项，
可以用于存在对图像变换有一定先验知识的情况，
或者对图像变换的范围有一定规定的情况。

于是，根据\ref{LossFunction}，配准问题转化成为了以下问题
\begin{equation}\label{OptimizationFunction}
  W^\ast=\underset{W}{arg} \ max \ \mathcal{M}(T,S\circ W)+\mathcal{R}(W)
\end{equation}
此处我们假设图像越相似，$\mathcal{M}$越大；
如果图像越相似$\mathcal{M}$越小，
应将式\ref{OptimizationFunction}中$max$变为$min$。


图像配准是医学图像处理分析的基本问题之一，
是该领域的一个热门研究方向。
此外，除了医学图像处理方向，在其它图像处理领域，图像配准也有广泛的应用。

\subsection{配准分类}\label{RegistrationClassification}
\pic[ht]{二维配准的一个例子\citeup{RegistrationSurvey}}{width=0.7\textwidth}{2DTransformation}
根据文献\cite{RegistrationSurvey,RegistrationSurveyNew}，
配准的分类标准有以下几项：
\begin{enumerate}
  \item 图像维度：二维图像配准，三维图像配准等。
  \item 配准特征：
    分为外部特征（例如螺丝钉标或者皮肤上画的标记），
    内部特征（例如图像灰度）和
    非图像特征（例如坐标系统），在\ref{SectionMetric}有更为详细的介绍。
  \item 图像形变模型：图像形变模型是在式子\ref{LossFunction}中将$S$变形，
    使其和$T$相似的变换$W$的数学模型。
    图像形变模型一般分为刚性变换，仿射变换，投影变换和曲线变换，
    在\ref{SectionTransformation}中有更详细的介绍。
  \item 变换域：分为局部变换和全局变换。
    图\ref{2DTransformation}对变换域和图像形变模型有形象的展示。
  \item 交互性：分为交互式，半自动，全自动配准。
  \item 优化过程：分为直接计算变换参数和搜寻最优参数，
    在\ref{SectionOptimization}中有更详细的介绍。
  \item 模态(modality)：一般指的图像采集方式，
    分为多模态（例如CT图像与MRI图像配准），
    单模态（例如CT图像和CT图像配准），对模型配准和对患者配准。
  \item 主体(subject)：分为同一患者的图像相互配准(intrasubject)，
    不同患者的图像之间配准(intersubject)，患者图像与图谱(atlas)。
  \item 对象(object)：被配准的图像中的扫描对象，包括头胸腹肢体等等。
\end{enumerate}

在这篇文章中，我们主要关注的是全自动的单模态心脏图像非刚性配准。


\subsection{相似性测度}\label{SectionMetric}

\subsection{形变模型}\label{SectionTransformation}
形变模型(deformation model)和
目标函数(objective function, loss function，即式\ref{OptimizationFunction})
与优化器(optimizer)一起，构成一个配准方法的三大要素\citeup{MultiAtlasSurvey}。

Iglesias2015, 2.3 Registration
The optimal choice of algorithm specifics largely depends on the
biomedical application, its goal (Yeo et al., 2010), and operational con-
straints, such as available computational resources, desired accuracy,
and restrictions on time. Once registration is complete, the resulting
spatial transform can then be used to map from the frame of one im-
age to the coordinates of another.
形变模型的选择决定了最终配准效果的上限，
所以，根据具体问题选择合适的形变模型，对与一个配准方法来说是非常重要的。

%copy 多模态医学图像配准研究
各种图像配准技术都需要建立自己的变换模型，变换空间的选取与图像的
变形特性有关，图像的几何变换可分为全局、局部两类，全局变换对整幅图像
都有效，通常涉及矩阵代数，典型的变换运算有平移、旋转和缩放;局部变换
有时又称为弹性变换它允许变换参数存在对空间的依赖性。对于局部变换，由
于局部变换随图像像素位置变化而变化，变换规则不完全一致，需要进行分段
小区域处理。空间变换描述了一幅图像中的位置映射到另一幅图像中的相应位
置之间的关系。经常用到的图像变换主要有刚体变换、仿射变换、射影变换和
非线性变换。下面分别对这四种变换进行数学描述：

\subsubsection{刚体变换}
如果用以配准的图像包含相同的内容，只是位置有所不同，那么就可以用
旋转和平移来描述配准变换---这就是刚性变换。在二维情况下，刚性变换包
含三个自由度，他们分别是：沿着两个个坐标轴的平移$t_x$、$t_v$，以及围绕旋转中
心的旋转角度够。如果允许改变旋转中心则有五个自由度。
通过这些未知量，我们可以构造一个刚性变换矩阵$T_{rigid}$。
它可以将一副图像中的任意点映射到另一幅图像中，成为与之对应的变换点。
这种变换可以通过旋转变换$R$和平移变换$t=(t_x,t_y)^T$来表示，
其中旋转矩阵R表示为：
\begin{equation}
  R=\begin{bmatrix}
    cos\varphi & -sin\varphi\\
    sin\varphi & cos\varphi\\
  \end{bmatrix}
\end{equation}
点$(x,y)^T$经刚体变换到点$(x^\prime,y^\prime)^T$的变换公式为：
\begin{equation}
  \begin{bmatrix}
    x^\prime\\
    y^\prime
  \end{bmatrix}=
  \begin{bmatrix}
    cos\varphi& -sin\varphi\\
    sin\varphi& cos\varphi
  \end{bmatrix}
  \begin{bmatrix}
    x\\
    y
  \end{bmatrix}+
  \begin{bmatrix}
    t_x\\
    t_y
  \end{bmatrix}
\end{equation}
其中旋转中心为坐标原点$(0,0)$，平移方向以沿坐标轴正向为正。
\subsubsection{仿射变换}
如果第一幅图像中的一条直线经过变换后映射到第二幅图像上仍为直线，
并且保持平行关系，则这样的变换称为仿射变换。
仿射变换可以分解为线性变换和平移变换。
在二维空间中,点$(x,y)^T$经仿射变换到点$(x^\prime,y^\prime)^T$的变换公式为：
%\begin{equation}
%  \mathbf {A} ={\begin{bmatrix}a_{11}&a_{12}&\cdots &a_{1n}\\a_{21}&a_{22}&\cdots &a_{2n}\\\vdots &\vdots &\ddots &\vdots \\a_{m1}&a_{m2}&\cdots &a_{mn}\end{bmatrix}}=\left({\begin{array}{rrrr}a_{11}&a_{12}&\cdots &a_{1n}\\a_{21}&a_{22}&\cdots &a_{2n}\\\vdots &\vdots &\ddots &\vdots \\a_{m1}&a_{m2}&\cdots &a_{mn}\end{array}}\right)=\left(a_{ij}\right)\in \mathbb {R} ^{m\times n}.
%\end{equation}


\begin{equation}
  \begin{bmatrix}
    x^\prime\\
    y^\prime
  \end{bmatrix}=
  \begin{bmatrix}
    a_{11}& a_{12}\\
    a_{21}& a_{22}
  \end{bmatrix}
  \begin{bmatrix}
    x\\
    y
  \end{bmatrix}+
  \begin{bmatrix}
    t_x\\
    t_y
  \end{bmatrix}
\end{equation}
其中
$\begin{bmatrix}
a_{11}& a_{12}\\ a_{21}& a_{22} 
\end{bmatrix}$
为满秩实矩阵，表示线性变换的部分，当它为单位正交矩阵时，
即与刚体变换的形式相同，所以刚体变换是仿射变换的特例。
\subsubsection{射影变换}
如果第一幅图像中的一条直线经过变换后映射到第二幅图像中仍为直线，
但平行关系基本不保持，则这样的变换称为射影变换。
射影变换保持点列的交比不变，
若A,B,C,D为同一直线上任意四点，则下式定义的CR(cross ratio)称为交比：
\begin{equation}
  \text{CR}(\text{A,B,C,D})=
  \frac{\text{AC}}{\text{BC}}:\frac{\text{AD}}{\text{BD}}
\end{equation}
射影变换下，点$(x,y,k)^T$经投影变换到
点$(x^\prime,y^\prime,k^\prime)^T$的变换公式为:
\begin{equation}
  \rho
  \begin{bmatrix}
    x^\prime\\y^\prime\\k^\prime
  \end{bmatrix}=
  \begin{bmatrix}
    a_{11}& a_{12}& a_{13}\\
    a_{21}& a_{22}& a_{23}\\
    a_{31}& a_{32}& a_{33}
  \end{bmatrix}
  \begin{bmatrix}
    x\\y\\k
  \end{bmatrix}
\end{equation}
其中$(x^\prime,y^\prime,k^\prime)$和$(x,y,k)^T$为二维点的齐次坐标，
消去$\rho$可得对应的非齐次坐标公式如下：
\begin{equation}
  \begin{cases}
    \bar{x}^\prime=\frac{x^\prime}{k^\prime}=
    \frac{a_{11}x+a_{12}y+a_{13}k}{a_{31}x+a_{32}y+a_{33}k}\\
    \bar{y}^\prime=\frac{y^\prime}{k^\prime}=
    \frac{a_{21}x+a_{22}y+a_{23}k}{a_{31}x+a_{32}y+a_{33}k}
  \end{cases}
\end{equation}

当$a_{31}=0$，$a_{32}=0$时，射影变换与仿射变换具有相同的形式。
\subsubsection{非线性变换}
非线性变换可以把直线变换为曲线。在2D空间中,可以用一下公式表示:
其中,F表示把第一幅图像映射到第二幅图像上的任意一种函数形式。典型的非
线性变换如多项式变换,在2D空间中,多项式函数可写成如下形式:
非线性变换比较适用于那些具有全局性形变的图像配准问题,以及整体近
似刚体,但局部有形变的配准情况。本文的医学图像配准主要针对刚体变换的
应用,如对脑部图像的配准。

\subsection{最优解寻找}\label{SectionOptimization}
最优解的寻找对于一个配准问题来说是至关重要的，
因为如果没有办法求解形变模型的参数，
使用再复杂的形变模型、挑选再适合的相似度测定方法，都是徒劳。

在\ref{RegistrationClassification}所展示的分类中，最优解寻找方法分为直接
对于式\ref{OptimizationFunction}这样一个优化问题，一般很难直接求解$W$，
只能通过一个不断迭代的过程来优化。

一个典型的配准框架如图\ref{RegistrationFramework}所示。
\pic[ht]{一个典型的配准框架\citeup{ITKBookDevelop}}%
{width=0.8\textwidth}{RegistrationFramework}

\subsection{插值方法?图像变换?}\label{SectionModality}

\section{图谱选择方法}

\subsection{相似度}
\subsection{元数据(metadata)}

\section{标签传播}
在完成图像配准之后，我们将得到一个

\section{图像融合方法}
在完成图谱选择并进行标签传播之后，我们将得到多个分割结果；
为了得到最终的分割结果，我们需要将多个结果融合起来。

\subsection{多数投票法}
多数投票法(majority voting)是一种简单但不失有效的方法。
多数投票法中，对于每一个部位，最终标记结果是所有分割结果中出现次数最多的标记，
这个方法使用了所有分割结果的信息。
然而他也有缺点，多数投票法并没有利用图像灰度信息。

加权投票法(weighted voting)是多数投票法的一个扩展，每个图谱都有一个权重，
权重与图谱和目标图像的相似度有关。

加权投票法如下：

\begin{equation}
  E_{WV}=max[f_1(x),\ldots,f_i(x)], i=1,2,3,\ldots,L
\end{equation}
\begin{equation}
  f_i(x)=\sum_{k=1}^{K=1}w_{k,i}(x), i=1,2,3,\ldots,L
\end{equation}
\begin{equation}
  w_{k,i}(x)=
  \begin{cases}
    1 & i=e_k(x)\\
    0 & i\ne e_k(x)
  \end{cases}
\end{equation}
式子中，

\subsection{STAPLE}

\subsection{Jonit Label Fusion}

\section{分割结果评价}%copy 基于多图谱的海马提自动分割方法研究
对分割结果进行评价，可有效地促进现有算法的提高与改进。
评价方法可分为主观评价与客观评价，
主观评价是指以人的主观判断作为评价的标准，
由人的视觉决定分割算法的优良程度，
这样易出现评价结果因人而异、评价不一的状况，
无法满足分割算法及分割结果定性、定量的分析要求。
因此，客观评价方法方为研究的重点，
本文的分割结果亦采用客观评价方法进行分析评价。
客观评价方法又可以分为分析法与实验法，
分析法是指直接地对采用的算法进行评价，
分析其原理、性质与特点，总结该算法的优缺点，
这种评价方法仅考虑算法本身，评价结果也只与算法的过程有关。
实验法则是将算法应用到实际中，对分割结果进行测试与对比，
从而归纳出该算法的性能与特点。
一般而言，在具体实施时，实验法除了需获得实际的分割结果外，
通常还需要参考图像，即医学专家手工分割结果，
并采用一定的评价测度，对它们进行对比计算。
常用的客观评价指标有平均距离、均方差、Dice相似性测度及绝对容积误差等。
\subsection{平均距离}
平均距离$D_{ave}$定义如下：
\begin{equation}
  D_{ave}=\sqrt{\frac{1}{N}\sum_x\frac{1}{m}\sum_{i=1}^m\lVert x-R_i(x)\rVert^2}
\end{equation}
其中$R_i(x)$表示图像$I$到集合$R_s$中，第$i$个元素的变换；
$N$表示像素的个数，$m$表示集合$R_s$元素的个数。
\subsection{均方差}
均方差$V_{ave}$的计算公式为:
\begin{equation}
  V_{ave}=\sqrt{\frac{1}{N}\sum_x\lVert x-D(x)\rVert^2}
\end{equation}
式中的$D$表示变形场，$N$表示像素的个数。
均方差是衡量变形场下形状变量信息的一个标准。
\subsection{Dice相似度}
Dice相似性测度是对分割结果与人工分割的参考图像的重叠率进行评价的，
计算公式如下所示:
\begin{equation}
  Dice(Se,Re)=\frac{2V(Se\cap Re)}{V(Se)+V(Re)}
\end{equation}
其中$Se$表示分割结果，$Re$表示人工分割的参考图像，
$V$表示分割区域的体积大小。
相似性测度Dice值越大，
说明分割结果与人工分割的参考图像的重叠率越高，结果越精确。
\subsection{绝对容积误差}
绝对容积误差是对分割结果与参考图像的体积差进行评价，计算方法如下所示：
\begin{equation}
  E(Se,Re)=\frac{\lvert V(Se)-V(Re)\rvert}{V(Re)}\times 100\%
\end{equation}
其中$V(Se)$表示分割结果的体积大小，$V(Re)$表示参考图像的体积大小。

\section{多图谱方法的未来发展}

\section{本章小结}
